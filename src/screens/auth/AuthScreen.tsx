import React, { useState, useEffect } from 'react';
import { View, StyleSheet, Alert, ScrollView, RefreshControl } from 'react-native';
import { useAuth } from '../../context/AuthContext';
import RegisterScreen from './RegisterScreen';
import LoginScreen from './LoginScreen';
import OTPVerificationScreen from './OTPVerificationScreen';
import SupabaseTOTPService from '../../services/SupabaseTOTPService';
import ToastService from '../../services/ToastService';
import { supabase } from '../../lib/supabase';

type AuthStep = 'login' | 'register' | 'otp';

interface AuthScreenProps {
  onAuthSuccess: () => void;
  onLoginProgressChange?: (inProgress: boolean) => void;
  onNeedsOTPVerification?: (needs: boolean) => void;
}

export default function AuthScreen({ onAuthSuccess, onLoginProgressChange, onNeedsOTPVerification }: AuthScreenProps) {
  const [currentStep, setCurrentStep] = useState<AuthStep>('login');
  const [userEmail, setUserEmail] = useState('');
  const [userPassword, setUserPassword] = useState('');
  const [refreshing, setRefreshing] = useState(false);
  const [useTOTP, setUseTOTP] = useState(false);
  const [totpConfig, setTotpConfig] = useState<any>(null);
  const [isTOTPNew, setIsTOTPNew] = useState(false);
  const [isLoginInProgress, setIsLoginInProgress] = useState(false);
  const { login, register, verifyOTP, resendOTP, isLoading, setAuthenticated } = useAuth();

  // Notificar cambios en el progreso del login
  useEffect(() => {
    if (onLoginProgressChange) {
      onLoginProgressChange(isLoginInProgress);
    }
  }, [isLoginInProgress, onLoginProgressChange]);

  const handleRegister = async (userData: {
    email: string;
    password: string;
    nombre: string;
    apellido: string;
  }) => {
    try {
      console.log('üîÑ Iniciando registro...', userData.email);
      
      // Registrar usuario (ahora env√≠a OTP autom√°ticamente)
      const registerResult = await register(userData);
      console.log('üìã Resultado del registro:', registerResult);
      
      if (!registerResult.success) {
        console.log('‚ùå Registro fall√≥:', registerResult.message);
        ToastService.error('Error de registro', registerResult.message || 'No se pudo registrar el usuario');
        return;
      }

      console.log('‚úÖ Registro exitoso, navegando a OTP...');
      setUserEmail(userData.email);
      setCurrentStep('otp');
      
      ToastService.success(
        'Registro Exitoso',
        'Te hemos enviado un c√≥digo de verificaci√≥n de 6 d√≠gitos a tu email'
      );
    } catch (error: any) {
      console.log('‚ùå Error en registro:', error);
      ToastService.error('Error inesperado', error.message || 'No se pudo registrar el usuario');
    }
  };

  const handleLogin = async (email: string, password: string) => {
    try {
      console.log('üîÑ Verificando credenciales...', email);
      
      setIsLoginInProgress(true);
      setUserEmail(email);
      setUserPassword(password);
      
      // SOLO verificar credenciales
      const result = await login(email, password);
      console.log('üìã Resultado de verificaci√≥n:', result);
      
      if (result.success) {
        // Credenciales correctas
        console.log('‚úÖ Credenciales correctas');
        
        // Verificar si el usuario tiene two_factor_enabled habilitado
        if (result.twoFactorEnabled === true) {
          // Si tiene 2FA habilitado ‚Üí ir a OTP
          console.log('üîê Usuario tiene 2FA habilitado, navegando a OTP...');
          setCurrentStep('otp');
          setIsLoginInProgress(false);
          // Establecer que necesita verificaci√≥n OTP
          if (onNeedsOTPVerification) {
            onNeedsOTPVerification(true);
          }
          // Enviar OTP autom√°ticamente
          console.log('üìß Enviando OTP autom√°ticamente...');
          try {
            const otpResult = await resendOTP(email);
            if (otpResult.success) {
              ToastService.success('Credenciales correctas', 'C√≥digo OTP enviado a tu email');
            } else {
              // Manejar rate limiting espec√≠ficamente
              if (otpResult.message?.includes('rate limit') || otpResult.message?.includes('exceeded')) {
                // Rate limit alcanzado, mostrar opci√≥n TOTP
                console.log('üîÑ Rate limit alcanzado, mostrando opci√≥n TOTP...');
                ToastService.warning(
                  'Rate Limit Alcanzado',
                  'Rate limit alcanzado. Puedes usar TOTP si lo tienes configurado.'
                );
                // No activar TOTP autom√°ticamente, dejar que el usuario lo active manualmente
              } else if (otpResult.message?.includes('8 seconds')) {
                ToastService.warning('Credenciales correctas', 'Debes esperar 8 segundos antes de solicitar otro c√≥digo');
              } else {
                ToastService.warning('Credenciales correctas', 'Verifica tu c√≥digo OTP (env√≠o fall√≥)');
              }
            }
          } catch (otpError: any) {
            console.log('‚ùå Error enviando OTP:', otpError);
            if (otpError.message?.includes('rate limit') || otpError.message?.includes('exceeded')) {
              // Rate limit alcanzado, mostrar opci√≥n TOTP
              console.log('üîÑ Rate limit alcanzado, mostrando opci√≥n TOTP...');
              ToastService.warning(
                'Rate Limit Alcanzado',
                'Rate limit alcanzado. Puedes usar TOTP si lo tienes configurado.'
              );
              // No activar TOTP autom√°ticamente, dejar que el usuario lo active manualmente
            } else {
              ToastService.warning('Credenciales correctas', 'Verifica tu c√≥digo OTP (env√≠o fall√≥)');
            }
          }
        } else {
          // Si no tiene 2FA habilitado ‚Üí ir directamente al home
          console.log('üöÄ Usuario sin 2FA, autenticando directamente...');
          setAuthenticated(true);
          setIsLoginInProgress(false);
          onAuthSuccess();
          ToastService.success('¬°Bienvenido!', 'Has iniciado sesi√≥n exitosamente');
        }
      } else {
        // Credenciales incorrectas ‚Üí quedarse en login
        console.log('‚ùå Credenciales incorrectas');
        setIsLoginInProgress(false);
        ToastService.error('Error al entrar', 'Credenciales incorrectas');
      }
    } catch (error: any) {
      setIsLoginInProgress(false);
      ToastService.error('Error de login', 'No se pudo verificar las credenciales');
    }
  };

  const handleVerifyOTP = async (code: string) => {
    try {
      if (useTOTP && totpConfig?.factorId) {
        // Verificar c√≥digo TOTP usando Supabase
        const result = await SupabaseTOTPService.verifyTOTP(totpConfig.factorId, code);
        if (result.success) {
          console.log('‚úÖ TOTP verificado exitosamente, estableciendo autenticaci√≥n');
          setAuthenticated(true);
          ToastService.success('¬°Bienvenido!', 'Has iniciado sesi√≥n exitosamente con TOTP');
          onAuthSuccess();
        } else {
          // TOTP incorrecto - lanzar error para que el componente maneje los intentos
          throw new Error(result.error || 'C√≥digo TOTP incorrecto');
        }
      } else {
        // Verificar c√≥digo OTP por email
        const result = await verifyOTP(userEmail, code, userPassword);
        if (result.success) {
          console.log('‚úÖ OTP verificado exitosamente, estableciendo autenticaci√≥n');
          setAuthenticated(true);
          ToastService.success('¬°Bienvenido!', 'Has iniciado sesi√≥n exitosamente');
          onAuthSuccess();
        } else {
          // OTP incorrecto - lanzar error para que el componente maneje los intentos
          throw new Error('C√≥digo OTP incorrecto');
        }
      }
    } catch (error: any) {
      console.log('Error verificando OTP:', error);
      throw error; // Re-lanzar el error para que el componente lo maneje
    }
  };

  const handleResendOTP = async () => {
    try {
      if (useTOTP && totpConfig) {
        // TOTP ya est√° activo, no mostrar c√≥digo
        ToastService.info(
          'TOTP Activo',
          'Usa TOTP como alternativa (c√≥digo cambia cada 30 segundos)'
        );
      } else {
        // Reenviar OTP por email
        const result = await resendOTP(userEmail);
        if (result.success) {
          ToastService.success(
            'C√≥digo Reenviado',
            'Te hemos enviado un nuevo c√≥digo de verificaci√≥n de 6 d√≠gitos'
          );
        } else {
          ToastService.error('Error', result.message || 'No se pudo reenviar el c√≥digo');
        }
      }
    } catch (error: any) {
      ToastService.error('Error', error.message || 'No se pudo reenviar el c√≥digo');
    }
  };

  const handleSwitchToTOTP = async () => {
    try {
      console.log('üîç Intentando activar TOTP...');
      
      // Primero verificar si hay una sesi√≥n activa
      const { data: { session } } = await supabase.auth.getSession();
      if (!session) {
        console.log('‚ùå No hay sesi√≥n activa');
        ToastService.warning(
          'TOTP No Disponible',
          'Debes estar autenticado para usar TOTP. Usa verificaci√≥n por email.'
        );
        setUseTOTP(false);
        return;
      }

      console.log('‚úÖ Sesi√≥n activa encontrada, obteniendo configuraci√≥n TOTP...');
      
      // Obtener la configuraci√≥n existente
      const result = await SupabaseTOTPService.getExistingTOTPConfig(userEmail);
      
      if (result.success && result.config) {
        console.log('‚úÖ Configuraci√≥n TOTP encontrada:', result.config);
        setTotpConfig(result.config);
        setUseTOTP(true);
        setIsTOTPNew(false);
        ToastService.success(
          'TOTP Activado',
          'Usa TOTP como alternativa (c√≥digo cambia cada 30 segundos)'
        );
      } else {
        console.log('‚ùå No se encontr√≥ configuraci√≥n TOTP:', result.error);
        ToastService.warning(
          'TOTP No Configurado',
          'No tienes TOTP configurado. Config√∫ralo primero en Ajustes.'
        );
        setUseTOTP(false);
        setIsTOTPNew(false);
      }
    } catch (error) {
      console.log('Error obteniendo configuraci√≥n TOTP:', error);
      ToastService.error('Error', 'No se pudo obtener la configuraci√≥n TOTP');
      setUseTOTP(false);
      setIsTOTPNew(false);
    }
  };

  const handleSwitchToEmail = () => {
    setUseTOTP(false);
    setTotpConfig(null);
    setIsTOTPNew(false);
    ToastService.info('Cambiado a Email', 'Ahora usar√°s verificaci√≥n por email');
  };

  const handleGoBack = () => {
    if (currentStep === 'otp') {
      setCurrentStep('login');
    } else if (currentStep === 'register') {
      setCurrentStep('login');
    }
  };

  // Funci√≥n para manejar cuando se agoten los intentos en OTP
  const handleOTPFailed = () => {
    console.log('‚ùå OTP fall√≥ - regresando a login');
    setCurrentStep('login');
    ToastService.warning('Demasiados intentos', 'Has agotado los 3 intentos. Regresa al login.');
  };

  const onRefresh = async () => {
    setRefreshing(true);
    // En las pantallas de auth, el refresh puede limpiar el estado
    setTimeout(() => {
      setRefreshing(false);
    }, 1000);
  };

  const renderCurrentStep = () => {
    console.log('üîÑ Renderizando paso actual:', currentStep);
    switch (currentStep) {
      case 'login':
        return (
          <LoginScreen
            onLogin={handleLogin}
            onNavigateToRegister={() => setCurrentStep('register')}
          />
        );
      case 'register':
        return (
          <RegisterScreen
            onRegister={handleRegister}
            onNavigateToLogin={() => setCurrentStep('login')}
          />
        );
      case 'otp':
        return (
          <OTPVerificationScreen
            email={userEmail}
            onVerifyOTP={handleVerifyOTP}
            onResendOTP={handleResendOTP}
            onGoBack={handleGoBack}
            onOTPFailed={handleOTPFailed}
            isLoading={isLoading}
            useTOTP={useTOTP}
            onSwitchToTOTP={handleSwitchToTOTP}
            onSwitchToEmail={handleSwitchToEmail}
            totpConfig={totpConfig}
            isTOTPNew={isTOTPNew}
          />
        );
      default:
        return null;
    }
  };

  return (
    <ScrollView 
      style={styles.container}
      contentContainerStyle={styles.scrollContent}
      refreshControl={
        <RefreshControl
          refreshing={refreshing}
          onRefresh={onRefresh}
          tintColor="#FFD700"
          colors={["#FFD700"]}
        />
      }
    >
      {renderCurrentStep()}
    </ScrollView>
  );
}

const styles = StyleSheet.create({
  container: {
    flex: 1,
  },
  scrollContent: {
    flexGrow: 1,
  },
});
