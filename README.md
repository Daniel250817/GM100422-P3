# TimeTrack Mobile üì±

**Aplicaci√≥n m√≥vil de gesti√≥n de tiempo y productividad con asistente de IA integrado**

## üìã Descripci√≥n

TimeTrack es una aplicaci√≥n m√≥vil desarrollada con React Native y Expo que permite gestionar tu tiempo de manera eficiente mediante sesiones de trabajo, rutinas personalizadas y horarios. Incluye un asistente de IA integrado con **Google Gemini** que te ayuda a controlar la aplicaci√≥n usando lenguaje natural.

## üöÄ Caracter√≠sticas Principales

### ‚ú® Funcionalidades Core

- **üîê Autenticaci√≥n Segura**
  - Registro e inicio de sesi√≥n con Supabase Auth
  - Verificaci√≥n por OTP (One-Time Password) v√≠a email
  - Autenticaci√≥n de dos factores (2FA/TOTP) con Google Authenticator
  - Sesiones persistentes con AsyncStorage
  - Logout seguro con confirmaci√≥n

- **üíº Gesti√≥n de Sesiones de Trabajo**
  - Iniciar y finalizar sesiones de trabajo
  - Seguimiento autom√°tico del tiempo empleado
  - Sesiones activas en tiempo real
  - Historial completo de jornadas
  - C√°lculo autom√°tico de duraci√≥n

- **üìÖ Gesti√≥n de Horarios**
  - Crear horarios personalizados por d√≠a de la semana
  - Activar/desactivar horarios
  - Visualizaci√≥n de disponibilidad semanal
  - Horarios recurrentes configurable

- **üîÑ Gesti√≥n de Rutinas**
  - Crear rutinas personalizadas
  - Activar/desactivar rutinas
  - Contador de completadas
  - Historial de ejecuci√≥n

- **ü§ñ Asistente de IA con Gemini**
  - Control por lenguaje natural
  - Respuestas contextuales inteligentes
  - Acciones autom√°ticas
  - Historial de conversaciones en Supabase
  - An√°lisis de intenci√≥n avanzado

- **üë§ Perfil de Usuario**
  - Avatar personalizable con imagen de perfil
  - Informaci√≥n personal (nombre, apellido, email)
  - Sincronizaci√≥n con Supabase
  - Almacenamiento de avatares en Supabase Storage

- **‚öôÔ∏è Configuraci√≥n**
  - Modo claro/oscuro (Dark Mode)
  - Sincronizaci√≥n de tema entre dispositivos
  - Configuraci√≥n del asistente de IA
  - Preferencias de usuario

## üõ†Ô∏è Stack Tecnol√≥gico

### Frontend
- **React Native** (v0.81.5)
- **Expo** (v54.0.14)
- **TypeScript** (v5.9.2)
- **React Navigation** (v7.x)
  - Stack Navigator
  - Bottom Tabs

### Backend Serverless (Supabase)
- **PostgreSQL** - Base de datos relacional
- **Supabase Auth** - Autenticaci√≥n y autorizaci√≥n
- **Supabase Storage** - Almacenamiento de archivos
- **Row Level Security (RLS)** - Seguridad a nivel de fila
- **Funciones de disparo (Triggers)** - Automatizaci√≥n

### IA y Machine Learning
- **Google Gemini** (gemini-2.0-flash-exp)
- **@google/generative-ai** (v0.24.1)

### Almacenamiento Local
- **AsyncStorage** - Persistencia de datos
- **Expo Crypto** - Cifrado y seguridad
- **Secure Store** - Credenciales seguras

### UI/UX
- **React Native Toast Message** - Notificaciones
- **Expo Linear Gradient** - Gradientes visuales
- **@expo/vector-icons** - Iconograf√≠a
- **Expo Barcode Scanner** - Lectura de c√≥digos QR (2FA)

---

## üì¶ Instalaci√≥n y Configuraci√≥n

### Requisitos Previos

- Node.js 18+
- npm o yarn
- Expo CLI
- Cuenta de Supabase
- (Opcional) API Key de Google Gemini

### Paso 1: Clonar e Instalar

```bash
# 1. Clonar el repositorio
git clone <repository-url>
cd frontend

# 2. Instalar dependencias
npm install

# 3. Verificar instalaci√≥n
npm start
```

### Paso 2: Configurar Variables de Entorno

Crea un archivo `.env` en la ra√≠z del proyecto (`frontend/`):

```env
# Supabase Configuration
EXPO_PUBLIC_SUPABASE_URL=https://tu-proyecto.supabase.co
EXPO_PUBLIC_SUPABASE_PUBLISHABLE_KEY=sb_publishable_xxx...

# Gemini AI Configuration (Opcional)
EXPO_PUBLIC_GEMINI_API_KEY=tu_api_key_de_gemini_aqui
```

**‚ö†Ô∏è Importante:**
- Nunca subas el archivo `.env` a Git
- Aseg√∫rate de que `.env` est√© en tu `.gitignore`
- Las variables deben empezar con `EXPO_PUBLIC_` para ser accesibles en el cliente

### Paso 3: Configurar Supabase

#### 3.1 Crear Proyecto en Supabase

1. Ve a [supabase.com](https://supabase.com)
2. Crea una cuenta o inicia sesi√≥n
3. Crea un nuevo proyecto:
   - **Nombre**: `timetrack-mobile`
   - **Regi√≥n**: Selecciona la m√°s cercana a ti
   - **Contrase√±a de base de datos**: Gu√°rdala de forma segura

#### 3.2 Obtener Credenciales

1. Ve a **Settings ‚Üí API** en tu proyecto
2. Copia:
   - **Project URL**: `https://xxxxx.supabase.co`
   - **Publishable Key**: `sb_publishable_xxx...` (recomendada)
   - O **Anon Key**: `eyJhbGci...` (legacy, funciona pero no recomendada)
3. P√©gala en tu archivo `.env`

#### 3.3 Crear la Base de Datos

1. Ve al **SQL Editor** en Supabase
2. Abre el archivo `supabase-restore-complete.sql`
3. Copia **TODO** el contenido
4. P√©galo en el SQL Editor
5. Ejecuta el script completo

‚úÖ **¬°Listo!** Tu base de datos estar√° completamente configurada con:
- ‚úÖ Todas las tablas
- ‚úÖ Funciones y triggers
- ‚úÖ Pol√≠ticas RLS
- ‚úÖ √çndices optimizados

#### 3.4 Configurar Storage (Para Avatares)

1. Ve a **Storage** en tu proyecto de Supabase
2. Crea un nuevo bucket:
   - **Nombre**: `avatars`
   - **P√∫blico**: No (privado)
3. Configura pol√≠ticas:
   - Los usuarios solo pueden subir su propio avatar
   - Los avatares son p√∫blicos para lectura

---

## ü§ñ Configuraci√≥n del Asistente de IA (Gemini)

### Opci√≥n 1: Usando Variables de Entorno (Recomendado)

1. **Obtener API Key de Gemini:**
   - Ve a [Google AI Studio](https://makersuite.google.com/app/apikey)
   - Inicia sesi√≥n con tu cuenta de Google
   - Haz clic en "Create API Key"
   - Copia la clave generada

2. **Agregar al `.env`:**
   ```env
   EXPO_PUBLIC_GEMINI_API_KEY=tu_api_key_de_gemini_aqui
   ```

3. **Reiniciar la aplicaci√≥n:**
   ```bash
   npx expo start --clear
   ```

‚úÖ **Ventajas:**
- Configuraci√≥n autom√°tica
- No necesitas ingresar la key manualmente
- Switch deshabilitado en la pantalla de configuraci√≥n

### Opci√≥n 2: Configuraci√≥n Manual en la App

1. Abre la aplicaci√≥n
2. Ve a **Configuraci√≥n ‚Üí Asistente IA**
3. Activa "Usar Google Gemini"
4. Pega tu API key
5. Prueba la conexi√≥n

### Costos de Gemini

- **Precio**: Gratis hasta **15 requests/minuto**
- **Uso t√≠pico**: Gratis para uso personal
- **Ventajas**: Sin costos, excelente calidad

---

## üîê Autenticaci√≥n: OTP y TOTP

### OTP (One-Time Password)

**¬øQu√© es?**
- C√≥digo de 6 d√≠gitos enviado por email
- Se usa para verificar el email durante login/registro
- Expira despu√©s de cierto tiempo

**Flujo:**
1. Usuario intenta login/registro
2. Se env√≠a c√≥digo OTP por email
3. Usuario ingresa c√≥digo en la app
4. Si es correcto, se autentica

**Rate Limiting:**
- **6 segundos** entre solicitudes del mismo email
- Si se alcanza el l√≠mite, se activa TOTP autom√°ticamente
- Mensaje: "Debes esperar X segundos antes de solicitar otro c√≥digo"

### TOTP (Time-Based One-Time Password)

**¬øQu√© es?**
- C√≥digo de 6 d√≠gitos que cambia cada 30 segundos
- Generado localmente en el dispositivo
- Compatible con Google Authenticator

**Cu√°ndo se usa:**
1. Cuando OTP no llega por email
2. Cuando hay rate limiting de email
3. Como alternativa m√°s r√°pida
4. Cuando el usuario tiene 2FA habilitado

**Configuraci√≥n:**
1. En la pantalla de OTP, presiona "Usar TOTP"
2. Escanea el c√≥digo QR con Google Authenticator
3. O ingresa el c√≥digo manualmente
4. El c√≥digo cambia cada 30 segundos

**Ventajas:**
- ‚úÖ No depende de email
- ‚úÖ Funciona sin conexi√≥n
- ‚úÖ M√°s r√°pido que OTP
- ‚úÖ Sin rate limiting

---

## üöÄ Uso del Proyecto

### Iniciar la Aplicaci√≥n

```bash
# Desarrollo (con hot reload)
npm start

# Android
npm run android

# iOS
npm run ios

# Web
npm run web
```

### Estructura de Navegaci√≥n

```
HomeScreen (Dashboard)
‚îú‚îÄ‚îÄ StartWorkScreen - Iniciar/cerrar jornada
‚îú‚îÄ‚îÄ ScheduleManagementScreen - Gestionar horarios
‚îú‚îÄ‚îÄ RoutineManagementScreen - Gestionar rutinas
‚îú‚îÄ‚îÄ ProfileScreen - Perfil de usuario
‚îú‚îÄ‚îÄ SettingsScreen - Configuraci√≥n
‚îÇ   ‚îî‚îÄ‚îÄ AIConfigScreen - Configuraci√≥n de IA
‚îî‚îÄ‚îÄ StatisticsScreen - Estad√≠sticas
```

### Flujos Principales

#### 1. Registro de Usuario

1. Presiona "Registrarse"
2. Completa nombre, apellido, email y contrase√±a
3. Recibir√°s un c√≥digo OTP por email
4. Ingresa el c√≥digo para verificar
5. ‚úÖ Se crea autom√°ticamente tu perfil en `profiles`
6. ‚úÖ Se crear√° `settings` cuando abras la pantalla de ajustes

#### 2. Login

1. Ingresa tu email y contrase√±a
2. Si tienes 2FA habilitado:
   - Recibir√°s OTP por email O
   - Usa TOTP si hay rate limiting
3. Ingresa el c√≥digo de verificaci√≥n
4. ‚úÖ Accedes al dashboard

#### 3. Iniciar Sesi√≥n de Trabajo

1. Ve a "Iniciar Jornada"
2. (Opcional) Agrega notas
3. Presiona "Iniciar"
4. ‚úÖ Se crea una sesi√≥n activa en `sesiones_trabajo`
5. El contador empieza a funcionar
6. Para finalizar, presiona "Finalizar"

#### 4. Crear Horario

1. Ve a "Gesti√≥n de Horarios"
2. Presiona "Agregar Horario"
3. Selecciona d√≠a de la semana
4. Define hora inicio y fin
5. ‚úÖ Se guarda en `horarios_asignados`
6. La duraci√≥n se calcula autom√°ticamente

#### 5. Crear Rutina

1. Ve a "Gesti√≥n de Rutinas"
2. Presiona "Agregar Rutina"
3. Ingresa t√≠tulo y descripci√≥n
4. ‚úÖ Se guarda en `rutinas`
5. Puedes iniciar la rutina desde el chat con IA

#### 6. Usar el Chat con IA

1. Presiona el bot√≥n de IA en cualquier pantalla
2. Escribe en lenguaje natural:
   - "Inicia mi √∫ltima rutina"
   - "Crea un horario de trabajo de 9 a 11"
   - "Empieza mi jornada"
   - "¬øCu√°l fue mi actividad reciente?"
3. La IA entender√° y ejecutar√° la acci√≥n
4. Todo el historial se guarda en `chat_history`

---

## ü§ñ Asistente de IA - Gu√≠a Completa

### Caracter√≠sticas

- **Control por Lenguaje Natural**: Escribe comandos como hablar√≠as normalmente
- **Respuestas Contextuales**: La IA conoce tus rutinas, horarios y sesiones
- **Acciones Autom√°ticas**: Puede ejecutar acciones sin que navegues manualmente
- **Historial Persistente**: Todas las conversaciones se guardan en Supabase

### Comandos Disponibles

#### **Rutinas**
```
"Inicia mi √∫ltima rutina"
"Empieza la rutina de ejercicio"
"¬øCu√°les son mis rutinas?"
"Ejecuta la rutina de estudio"
"Termina mi rutina actual"
```

#### **Horarios**
```
"Crea un horario de trabajo"
"Programa mi estudio de 9 a 11"
"Haz un horario para ma√±ana de 14 a 16"
"¬øCu√°l es mi horario actual?"
"Elimina mi horario del lunes"
```

#### **Jornadas de Trabajo**
```
"Inicia mi jornada"
"Empieza a trabajar en el proyecto X"
"¬øTengo alguna sesi√≥n activa?"
"Finaliza mi sesi√≥n actual"
"¬øCu√°nto tiempo trabaj√© hoy?"
```

#### **Informaci√≥n**
```
"¬øCu√°l fue mi √∫ltima actividad?"
"Mu√©strame mi progreso"
"Resumen de mi d√≠a"
"¬øQu√© rutinas tengo activas?"
```

### Contexto del Usuario

La IA tiene acceso a:
- ‚úÖ Rutinas disponibles y su estado
- ‚úÖ Horarios configurados
- ‚úÖ Sesiones activas y recientes
- ‚úÖ Historial de actividad
- ‚úÖ Estad√≠sticas de uso

### Integraci√≥n T√©cnica

**Archivos principales:**
- `AIChatService.ts` - Servicio principal de IA
- `GeminiService.ts` - Integraci√≥n con Google Gemini
- `ChatHistoryService.ts` - Gesti√≥n del historial
- `AIChatModal.tsx` - Componente del chat

**Flujo de funcionamiento:**
1. Usuario escribe mensaje
2. `AIChatService` analiza la intenci√≥n con Gemini
3. Se obtiene contexto completo del usuario
4. Gemini genera respuesta inteligente y contextual
5. Se ejecuta acci√≥n si es necesario (start_routine, create_schedule, etc.)
6. Todo se guarda en `chat_history` con metadata

---

## üîß Soluci√≥n de Problemas

### OTP No Llega al Email

#### Verificaci√≥n R√°pida:
1. **Revisa la carpeta de spam**
2. **Verifica el email** que ingresaste
3. **Espera 6 segundos** entre solicitudes (rate limiting)

#### Soluci√≥n Completa:

**1. Configurar SMTP en Supabase:**
   - Ve a **Settings ‚Üí Auth ‚Üí SMTP Settings**
   - Habilita "Enable custom SMTP"
   - Configura para Gmail:
     ```
     Host: smtp.gmail.com
     Port: 587
     Username: tu-email@gmail.com
     Password: [contrase√±a-de-aplicaci√≥n]
     ```

**2. Verificar Email Templates:**
   - Ve a **Authentication ‚Üí Email Templates**
   - Verifica que las plantillas est√©n configuradas

**3. Usar TOTP como Alternativa:**
   - Si OTP no llega, presiona "Usar TOTP"
   - Escanea el c√≥digo QR con Google Authenticator
   - Usa el c√≥digo que cambia cada 30 segundos

#### Rate Limiting de OTP

**¬øQu√© es el Rate Limiting?**
Supabase limita el n√∫mero de solicitudes de OTP por email para prevenir spam y abuso:
- **6 segundos** entre solicitudes del mismo email
- **L√≠mite diario** por email (var√≠a seg√∫n el plan)

**Soluci√≥n Autom√°tica Implementada:**
Cuando se alcanza el rate limit, la app autom√°ticamente:
1. ‚úÖ **Detecta el rate limiting**
2. ‚úÖ **Activa TOTP** como alternativa
3. ‚úÖ **Configura TOTP** para verificaci√≥n
4. ‚úÖ **Informa al usuario** que use TOTP

**Tiempos de Espera:**
- **Rate Limit de 6 segundos:**
  - Espera 6 segundos entre solicitudes
  - Mensaje: "Debes esperar 6 segundos antes de solicitar otro c√≥digo"
  
- **Rate Limit Excedido:**
  - Espera varios minutos (hasta 1 hora)
  - Se activa TOTP autom√°ticamente
  - Mensaje: "Rate limit alcanzado. Usa TOTP"

**Flujos de la App:**

**Sin Rate Limiting:**
```
Login ‚Üí OTP enviado por email ‚Üí Verificar c√≥digo ‚Üí Home
```

**Con Rate Limiting (TOTP Autom√°tico):**
```
Login ‚Üí Rate limit detectado ‚Üí TOTP activado ‚Üí Verificar c√≥digo TOTP ‚Üí Home
```

**Con Rate Limiting (Esperar):**
```
Login ‚Üí Rate limit detectado ‚Üí Esperar ‚Üí Reintentar ‚Üí OTP enviado ‚Üí Home
```

**Mejores Pr√°cticas:**

**Para Desarrollo:**
- ‚úÖ Usar TOTP cuando hay rate limiting
- ‚úÖ No hacer muchas pruebas seguidas
- ‚úÖ Usar emails de prueba diferentes

**Para Producci√≥n:**
- ‚úÖ Configurar SMTP personalizado (reduce rate limiting)
- ‚úÖ Implementar TOTP como alternativa principal
- ‚úÖ Monitorear l√≠mites de uso

**Soluci√≥n de Problemas Espec√≠ficos:**

- **"Rate limit exceeded":**
  - Soluci√≥n: Usar TOTP o esperar
  - Tiempo: 5-60 minutos
  
- **"You must wait X seconds":**
  - Soluci√≥n: Esperar el tiempo indicado
  - Reintentar: Despu√©s del tiempo

- **TOTP no funciona:**
  - Verificar: Que el c√≥digo sea actual (30 segundos)
  - Regenerar: Presionar "Usar TOTP" nuevamente

**Monitoreo:**
En los logs ver√°s:
```
üîÑ Rate limit alcanzado, activando TOTP como alternativa...
TOTP Activado: 123456 (cambia cada 30 segundos)
‚úÖ OTP verificado, usuario autenticado
```

**Indicadores de Rate Limiting:**
- ‚ùå `email rate limit exceeded`
- ‚è∞ `you can only request this after X seconds`
- üîÑ `Rate limit alcanzado, activando TOTP`

**Configuraci√≥n en Supabase:**
1. Ve a **Settings ‚Üí Auth**
2. Revisa **Rate Limiting** settings
3. **Plan Pro**: Permite configurar l√≠mites personalizados
4. **Plan Free**: L√≠mites fijos de Supabase

### Error: "Invalid API key" (Gemini)

1. Verifica que tu API key sea v√°lida
2. Aseg√∫rate de que la key tenga permisos para Gemini
3. Revisa que est√© correctamente en el `.env`
4. Reinicia la app con `npx expo start --clear`

### Error: "Database error saving new user"

Este error indica que la funci√≥n `handle_new_user` tiene problemas. 

**Soluci√≥n:**
1. Ve al SQL Editor en Supabase
2. Ejecuta el script `supabase-restore-complete.sql` completo
3. Esto actualizar√° la funci√≥n `handle_new_user` correctamente

### Settings no se actualizan en la UI

1. Aseg√∫rate de que `useSettings` est√© recargando despu√©s de cambios
2. Verifica que el hook est√© usando `settingsData` del hook
3. Reinicia la pantalla de ajustes

---

## üèóÔ∏è Arquitectura

### Estructura del Proyecto

```
frontend/
‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îú‚îÄ‚îÄ components/          # Componentes reutilizables
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ AIChatModal.tsx      # Modal de chat con IA
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ QRScanner.tsx         # Esc√°ner QR para 2FA
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ SimpleSupabaseAuth.tsx # Autenticaci√≥n Supabase
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ TOTPSetupModal.tsx    # Configuraci√≥n TOTP
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ ui/                   # Componentes UI b√°sicos
‚îÇ   ‚îÇ
‚îÇ   ‚îú‚îÄ‚îÄ context/             # Context API para estado global
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ AuthContext.tsx         # Autenticaci√≥n
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ SupabaseAuthContext.tsx # Auth Supabase
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ ThemeContext.tsx        # Tema
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ NavigationContext.tsx   # Navegaci√≥n
‚îÇ   ‚îÇ
‚îÇ   ‚îú‚îÄ‚îÄ hooks/                # Custom hooks
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ useSettings.ts         # Gestiona configuraciones
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ useThemedStyles.ts    # Estilos tem√°ticos
‚îÇ   ‚îÇ
‚îÇ   ‚îú‚îÄ‚îÄ interfaces/           # Tipos TypeScript
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Routine.ts
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Schedule.ts
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Session.ts
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ User.ts
‚îÇ   ‚îÇ
‚îÇ   ‚îú‚îÄ‚îÄ lib/                  # Utilidades
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ supabase.ts           # Cliente de Supabase
‚îÇ   ‚îÇ
‚îÇ   ‚îú‚îÄ‚îÄ screens/              # Pantallas de la aplicaci√≥n
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ auth/                 # Autenticaci√≥n
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ HomeScreen.tsx         # Dashboard
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ StartWorkScreen.tsx   # Iniciar jornada
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ ScheduleManagementScreen.tsx
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ RoutineManagementScreen.tsx
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ ProfileScreen.tsx
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ SettingsScreen.tsx
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ AIConfigScreen.tsx
‚îÇ   ‚îÇ
‚îÇ   ‚îî‚îÄ‚îÄ services/              # Servicios y l√≥gica de negocio
‚îÇ       ‚îú‚îÄ‚îÄ AIChatService.ts         # Servicio principal de IA
‚îÇ       ‚îú‚îÄ‚îÄ GeminiService.ts         # Integraci√≥n con Gemini
‚îÇ       ‚îú‚îÄ‚îÄ ChatHistoryService.ts    # Historial de chat
‚îÇ       ‚îú‚îÄ‚îÄ SettingsService.ts       # Configuraci√≥n
‚îÇ       ‚îú‚îÄ‚îÄ SupabaseAuthService.ts   # Autenticaci√≥n
‚îÇ       ‚îú‚îÄ‚îÄ SupabaseSessionService.ts  # Sesiones
‚îÇ       ‚îú‚îÄ‚îÄ SupabaseScheduleService.ts # Horarios
‚îÇ       ‚îú‚îÄ‚îÄ SupabaseRoutineService.ts   # Rutinas
‚îÇ       ‚îî‚îÄ‚îÄ SupabaseStorageService.ts  # Storage
‚îÇ
‚îú‚îÄ‚îÄ .env                      # Variables de entorno (no subir a Git)
‚îú‚îÄ‚îÄ App.tsx                   # Punto de entrada
‚îú‚îÄ‚îÄ supabase-restore-complete.sql # Script de restauraci√≥n de BD
‚îî‚îÄ‚îÄ package.json
```

### Flujo de Datos

```
Usuario ‚Üí Pantalla ‚Üí Servicio ‚Üí Supabase ‚Üí Base de Datos
                    ‚Üì
                 Context/Hook
                    ‚Üì
              Actualizaci√≥n de UI
```

---

## üìä Base de Datos

### Esquema Actual

El proyecto usa **6 tablas principales**:

1. **`profiles`** - Perfiles de usuario (extiende auth.users)
2. **`settings`** - Configuraciones de usuario
3. **`sesiones_trabajo`** - Sesiones de trabajo registradas
4. **`horarios_asignados`** - Horarios de trabajo semanales
5. **`rutinas`** - Rutinas de trabajo
6. **`chat_history`** - Historial de conversaciones con IA

#### Estructura de `chat_history`

La tabla `chat_history` almacena todo el historial de conversaciones con el asistente de IA:

| Campo | Tipo | Descripci√≥n |
|-------|------|-------------|
| `id` | UUID | Identificador √∫nico del mensaje (PK) |
| `user_id` | UUID | ID del usuario (FK a auth.users) |
| `session_id` | UUID | ID de la sesi√≥n de chat (agrupa mensajes) |
| `role` | VARCHAR(20) | Rol: 'user' o 'assistant' |
| `content` | TEXT | Contenido del mensaje |
| `intent` | VARCHAR(50) | Intenci√≥n detectada por la IA |
| `action_type` | VARCHAR(50) | Tipo de acci√≥n ejecutada |
| `action_data` | JSONB | Datos de la acci√≥n en formato JSON |
| `response_time_ms` | INTEGER | Tiempo de respuesta en milisegundos |
| `tokens_used` | INTEGER | Tokens utilizados (para facturaci√≥n) |
| `created_at` | TIMESTAMP WITH TIME ZONE | Fecha de creaci√≥n |
| `updated_at` | TIMESTAMP WITH TIME ZONE | Fecha de √∫ltima actualizaci√≥n |

**√çndices:**
- `idx_chat_history_user_id` - B√∫squedas por usuario
- `idx_chat_history_session_id` - B√∫squedas por sesi√≥n
- `idx_chat_history_created_at` - Ordenamiento temporal
- `idx_chat_history_intent` - An√°lisis de intenciones
- `idx_chat_history_user_session` - Consultas frecuentes (compuesto)

**Uso en la Aplicaci√≥n:**

El servicio `ChatHistoryService` gestiona autom√°ticamente:
- Guarda todos los mensajes del usuario y del asistente
- Registra m√©tricas de rendimiento (tiempo de respuesta, tokens)
- Mantiene el contexto de la conversaci√≥n
- Permite an√°lisis de patrones de uso

**Ejemplo de consultas √∫tiles:**

```sql
-- Obtener historial de una sesi√≥n
SELECT * FROM chat_history 
WHERE user_id = auth.uid() 
AND session_id = 'session-uuid'
ORDER BY created_at ASC;

-- Intenciones m√°s comunes
SELECT intent, COUNT(*) as count
FROM chat_history 
WHERE user_id = auth.uid()
AND intent IS NOT NULL
GROUP BY intent
ORDER BY count DESC;

-- Estad√≠sticas del usuario
SELECT 
  COUNT(*) as total_messages,
  COUNT(CASE WHEN role = 'user' THEN 1 END) as user_messages,
  COUNT(CASE WHEN role = 'assistant' THEN 1 END) as assistant_messages,
  AVG(response_time_ms) as avg_response_time,
  SUM(tokens_used) as total_tokens
FROM chat_history 
WHERE user_id = auth.uid()
AND created_at >= NOW() - INTERVAL '30 days';
```

### Row Level Security (RLS)

Todas las tablas tienen RLS habilitado:
- Los usuarios solo pueden ver/modificar sus propios datos
- No necesitas agregar `WHERE user_id = auth.uid()` manualmente
- Las pol√≠ticas RLS lo hacen autom√°ticamente

### Caracter√≠sticas

- ‚úÖ **Foreign Keys** con `ON DELETE CASCADE`
- ‚úÖ **Triggers autom√°ticos** para `updated_at`
- ‚úÖ **√çndices optimizados** para consultas frecuentes
- ‚úÖ **Creaci√≥n autom√°tica de perfiles** al registrar usuarios

**üìñ Para m√°s detalles sobre el esquema, consulta [SUPABASE_COMPLETE_GUIDE.md](./SUPABASE_COMPLETE_GUIDE.md)**

---

## üì¶ Generar APK

### Instalaci√≥n de EAS CLI

```bash
npm install -g eas-cli
```

### Configuraci√≥n

```bash
eas build:configure
```

### Build de Producci√≥n

```bash
# Android
eas build --platform android --profile production

# iOS
eas build --platform ios --profile production
```

El APK/IPA se generar√° en la nube y te llegar√° un enlace para descargarlo.

---

## üìñ Documentaci√≥n Adicional

- **[SUPABASE_COMPLETE_GUIDE.md](./SUPABASE_COMPLETE_GUIDE.md)** - **Gu√≠a completa de Supabase y esquema de base de datos** üóÑÔ∏è
- **[ARCHITECTURE.md](./ARCHITECTURE.md)** - Diagrama completo de infraestructura en la nube üèóÔ∏è

---

## üîí Seguridad

### Autenticaci√≥n Multi-Factor

1. **Login con Email/Password**
   - Verificaci√≥n de credenciales
   - Validaci√≥n de usuario

2. **OTP (One-Time Password)**
   - Enviado por email
   - 6 d√≠gitos
   - Expiraci√≥n autom√°tica
   - Rate limiting: 1 c√≥digo cada 6 segundos

3. **TOTP (Time-Based One-Time Password)**
   - Compatible con Google Authenticator
   - QR Code para configuraci√≥n
   - C√≥digo cambia cada 30 segundos
   - Funciona sin conexi√≥n a internet

### Protecci√≥n de Datos

- **RLS**: Todos los datos protegidos a nivel de base de datos
- **AsyncStorage**: Persistencia local segura
- **Supabase Auth**: JWT con expiraci√≥n autom√°tica
- **Encriptaci√≥n**: Crypto-JS para datos sensibles

---

## üéØ Estado Actual

### ‚úÖ Funcionalidades Implementadas

- ‚úÖ Registro y login de usuarios
- ‚úÖ Verificaci√≥n por OTP
- ‚úÖ Autenticaci√≥n 2FA/TOTP
- ‚úÖ Gesti√≥n de sesiones de trabajo
- ‚úÖ Gesti√≥n de horarios
- ‚úÖ Gesti√≥n de rutinas
- ‚úÖ Chat con IA usando Gemini
- ‚úÖ Historial de conversaciones
- ‚úÖ Perfil de usuario con avatar
- ‚úÖ Modo claro/oscuro
- ‚úÖ Notificaciones toast
- ‚úÖ Navegaci√≥n completa

### üîÑ En Desarrollo

- üîÑ Estad√≠sticas avanzadas
- üîÑ Exportaci√≥n de datos
- üîÑ Notificaciones push
- üîÑ Sincronizaci√≥n offline


---

## üìÑ Licencia

Este proyecto es publico con licencia MIT y propiedad de Daniel250817 (User Gihub).

## üë§ Autor

**Julio Daniel Guardado Mart√≠nez** - *Desarrollador Principal*

---

**TimeTrack** - Gestiona tu tiempo de manera inteligente con IA ü§ñ
